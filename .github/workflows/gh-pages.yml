# Workflow for building and deploying to the gh-pages branch
name: Build and Deploy to gh-pages branch

on:
  # Runs on pushes of tags that look like versions (e.g. v1.0, v2.3.4)
  push:
    tags:
      - 'v*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Fetches all history for all branches and tags to find the branch from the tag
          fetch-depth: 0

      - name: Find branch and update version
        # This step only runs for tag pushes.
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- Find Branch ---
          BRANCHES=$(git branch -r --contains ${{ github.sha }} | grep -v 'HEAD ->' | grep -v 'chore/version-bump-' | sed 's/origin\///g')
          BRANCH_COUNT=$(echo "$BRANCHES" | wc -l)
          if [ "$BRANCH_COUNT" -ne 1 ]; then
            echo "Error: Tag ${{ github.ref_name }} must exist on exactly one branch."
            echo "Found on branches: $BRANCHES"
            exit 1
          fi
          BRANCH_NAME=$(echo "$BRANCHES" | tr -d '[:space:]')
          echo "Found unique branch: '${BRANCH_NAME}'"
          git checkout $BRANCH_NAME
          
          # --- Configure Git ---
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # --- Get Version ---
          VERSION_TAG=${{ github.ref_name }}
          VERSION=${VERSION_TAG#v}
          echo "Attempting to update to version ${VERSION} on branch ${BRANCH_NAME}"
          
          # --- DEBUG: BEFORE NPM VERSION ---
          echo "---"
          echo "[DEBUG] Git status before:"
          git status -s
          echo "[DEBUG] package.json content before:"
          cat package.json
          echo "---"
          
          # --- Run NPM Version ---
          npm version $VERSION --no-git-tag-version --allow-same-version
          
          # --- DEBUG: AFTER NPM VERSION ---
          echo "---"
          echo "[DEBUG] Git status after:"
          git status -s
          echo "[DEBUG] package.json content after:"
          cat package.json
          echo "---"
          
          # --- Check for changes, commit, and Push ---
          # We check if package.json or package-lock.json were modified.
          if [[ -z $(git status -s package.json package-lock.json) ]]; then
            echo "No changes detected in package.json or package-lock.json."
          else
            git add package.json package-lock.json
            git commit -m "chore(version): bump to ${VERSION_TAG}"
            echo "Checking if branch '${BRANCH_NAME}' is the main branch."
            if [[ "$BRANCH_NAME" == "main" ]]; then
              echo "Branch is main. Creating a pull request..."
              BUMP_BRANCH_NAME="chore/version-bump-${VERSION_TAG}"
              git push origin HEAD:$BUMP_BRANCH_NAME
              gh pr create --base "$BRANCH_NAME" --head "$BUMP_BRANCH_NAME" --title "chore(version): bump to ${VERSION_TAG}" --body "Automatic version bump to ${VERSION_TAG}."
            else
              echo "Branch is not main (it is '${BRANCH_NAME}'). Pushing directly."
              echo "Changes detected. Committing and pushing..."
              git push origin $BRANCH_NAME
            fi
          fi

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_BASE_PATH: /${{ github.event.repository.name }}

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
