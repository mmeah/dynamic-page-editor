# Workflow for building and deploying to the gh-pages branch
name: Build and Deploy to gh-pages branch

on:
  # Runs on pushes of tags that look like versions (e.g. v1.0, v2.3.4)
  push:
    tags:
      - 'v*'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # Fetches all history for all branches and tags to find the branch from the tag
          fetch-depth: 0

      - name: Find branch and update version
        # This step only runs for tag pushes.
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # List all remote branches that contain the tagged commit
          BRANCHES=$(git branch -r --contains ${{ github.sha }} | grep -v 'HEAD ->' | sed 's/origin\///g')
          
          # Count them
          BRANCH_COUNT=$(echo "$BRANCHES" | wc -l)
          
          if [ "$BRANCH_COUNT" -ne 1 ]; then
            echo "Error: Tag ${{ github.ref_name }} must exist on exactly one branch."
            echo "Found on branches: $BRANCHES"
            exit 1
          fi
          
          BRANCH_NAME=$(echo "$BRANCHES")
          echo "Found unique branch: ${BRANCH_NAME}"
          
          # Switch to the found branch to commit changes
          git checkout $BRANCH_NAME
          
          # Configure git user for the commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get version from the tag
          VERSION_TAG=${{ github.ref_name }}
          VERSION=${VERSION_TAG#v}
          
          echo "Updating package.json to version ${VERSION} on branch ${BRANCH_NAME}"
          
          # Use npm version to update files and create a commit if necessary
          npm version $VERSION --no-git-tag-version --allow-same-version -m "chore(version): bump to %s"
          
          # Check if the local branch is ahead of the remote, which indicates a new commit was created.
          if [ $(git rev-parse HEAD) = $(git rev-parse @{u}) ]; then
            echo "No new commit was created. The version in package.json is likely already up to date."
          else
            echo "New version commit created. Pushing to origin..."
            git push origin $BRANCH_NAME
          fi

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_BASE_PATH: /${{ github.event.repository.name }}

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./out
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
